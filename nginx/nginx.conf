events {}

http {

  upstream app_backend {
    server green:80 max_fails=1 fail_timeout=0;
    server blue:80 backup;
  }

  server {
    listen 80;

    location / {
      proxy_pass http://app_backend;

      proxy_http_version 1.1;
      proxy_set_header Connection "";

      # ğŸ”¥ FAIL FAST
      proxy_connect_timeout 1s;
      proxy_send_timeout   1s;
      proxy_read_timeout   1s;

      # ğŸ”¥ CRITICAL: do not spend all time on first upstream
      proxy_next_upstream_timeout 0;

      # ğŸ” RETRY LOGIC
      proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
      proxy_next_upstream_tries 2;
    }
  }
}

